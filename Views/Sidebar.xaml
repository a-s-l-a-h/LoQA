<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:LoQA.Models"
             x:Class="LoQA.Views.Sidebar"
             BackgroundColor="{StaticResource SidebarBackgroundColor}">

    <!--
    Main Grid Layout:
    - Row 0 (Auto):   Fixed top content (Title, buttons, slider). This section's height is determined by its content.
    - Row 1 (*):      Scrollable history list that fills ALL remaining vertical space.
    - Row 2 (Auto):   Fixed Settings button at the bottom. This section's height is also determined by its content.
    -->
    <Grid RowDefinitions="Auto, *, Auto">

        <!-- ============================================= -->
        <!-- TOP SECTION (Fixed Content) - Grid.Row="0"    -->
        <!-- ============================================= -->
        <VerticalStackLayout Grid.Row="0" Padding="10" Spacing="15">

            <Label Text="Lō-QA"
                   FontSize="Header"
                   FontAttributes="Bold"
                   TextColor="White"
                   HorizontalOptions="Center"
                   Margin="0,5,0,0"/>

            <Button x:Name="ModelsButton"
                    Text="⚙️ Models"
                    Clicked="ModelsButton_Clicked"
                    BackgroundColor="#2C3E50"
                    BorderColor="Transparent"
                    BorderWidth="1"/>

            <Button x:Name="NewChatButton"
                    Text="＋ New Chat"
                    FontAttributes="Bold"
                    Clicked="NewChatButton_Clicked"
                    BackgroundColor="{StaticResource PrimaryAccentColor}"
                    TextColor="{StaticResource ButtonTextColor}"/>

            <VerticalStackLayout Spacing="5">
                <Label Text="Temperature" TextColor="{StaticResource PrimaryTextColor}" FontAttributes="Bold"/>
                <Slider x:Name="TemperatureSlider" Minimum="0.0" Maximum="2.0" Value="0.8" ValueChanged="TemperatureSlider_ValueChanged" />
                <Label x:Name="TemperatureValueLabel" Text="Current: 0.8" HorizontalOptions="Center" TextColor="{StaticResource SecondaryTextColor}"/>
            </VerticalStackLayout>

        </VerticalStackLayout>

        <!-- ==================================================== -->
        <!-- MIDDLE SECTION (Scrollable History) - Grid.Row="1"   -->
        <!-- ==================================================== -->
        <!-- This inner Grid ensures the header stays fixed at the top of this scrollable section. -->
        <Grid Grid.Row="1" RowDefinitions="Auto, *">

            <Label Grid.Row="0" Text="History" Margin="10,15,10,5" FontSize="Small" FontAttributes="Bold" TextColor="{StaticResource SecondaryTextColor}"/>

            <!-- The CollectionView is inherently scrollable and will fill the available space within this row. -->
            <CollectionView Grid.Row="1"
                              x:Name="ConversationsListView"
                              SelectionMode="Single"
                              ItemsSource="{Binding ConversationList}"
                              SelectionChanged="ConversationsListView_SelectionChanged">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:ChatHistory">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItem Text="Delete"
                                           BackgroundColor="{StaticResource DestructiveColor}"
                                           Invoked="DeleteConversation_Invoked"
                                           CommandParameter="{Binding .}"/>
                            </SwipeView.RightItems>
                            <Grid Padding="15,12">
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup Name="CommonStates">
                                        <VisualState Name="Normal" />
                                        <VisualState Name="Selected">
                                            <VisualState.Setters>
                                                <Setter Property="BackgroundColor" Value="{StaticResource ListItemSelectedColor}" />
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>
                                <Label Text="{Binding Name}"
                                       TextColor="{StaticResource PrimaryTextColor}"
                                       FontAttributes="Bold"
                                       LineBreakMode="TailTruncation"
                                       VerticalOptions="Center"/>
                            </Grid>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>

        <!-- ============================================== -->
        <!-- BOTTOM SECTION (Fixed Content) - Grid.Row="2"  -->
        <!-- ============================================== -->
        <Button Grid.Row="2"
                x:Name="SettingsButton"
                Text="⚙️ Settings"
                Clicked="SettingsButton_Clicked"
                BackgroundColor="#2C3E50"
                BorderColor="Transparent"
                BorderWidth="1"
                Margin="10"/>

    </Grid>
</ContentView>