<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:LoQA.Models"
             x:Class="LoQA.Views.ChatPage"
             Title="EasyChat"
             BackgroundColor="{StaticResource PageBackgroundColor}">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition x:Name="SidebarColumn" Width="300" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- ===================================== -->
        <!-- ===== LEFT SIDEBAR (HISTORY) ====== -->
        <!-- ===================================== -->
        <Grid Grid.Column="0" RowDefinitions="Auto, *" BackgroundColor="{StaticResource SidebarBackgroundColor}" x:Name="SidebarGrid">
            <Button Grid.Row="0"
                    x:Name="NewChatButton"
                    Text="＋ New Chat"
                    FontAttributes="Bold"
                    Clicked="NewChatButton_Clicked"
                    Margin="10"
                    BackgroundColor="{StaticResource PrimaryAccentColor}"
                    TextColor="{StaticResource ButtonTextColor}"/>

            <CollectionView Grid.Row="1"
                            x:Name="ConversationsListView"
                            SelectionMode="Single"
                            SelectionChanged="ConversationsListView_SelectionChanged">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:ChatHistory">
                        <SwipeView>
                            <SwipeView.RightItems>
                                <SwipeItem Text="Delete"
                                           BackgroundColor="{StaticResource DestructiveColor}"
                                           Invoked="DeleteConversation_Invoked"
                                           CommandParameter="{Binding .}"/>
                            </SwipeView.RightItems>

                            <Grid Padding="15,12">
                                <VisualStateManager.VisualStateGroups>
                                    <VisualStateGroup Name="CommonStates">
                                        <VisualState Name="Normal" />
                                        <VisualState Name="Selected">
                                            <VisualState.Setters>
                                                <Setter Property="BackgroundColor" Value="{StaticResource ListItemSelectedColor}" />
                                            </VisualState.Setters>
                                        </VisualState>
                                    </VisualStateGroup>
                                </VisualStateManager.VisualStateGroups>

                                <Label Text="{Binding Name}"
                                       TextColor="{StaticResource PrimaryTextColor}"
                                       FontAttributes="Bold"
                                       LineBreakMode="TailTruncation"
                                       VerticalOptions="Center"/>
                            </Grid>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <StackLayout Padding="20" VerticalOptions="Center">
                        <Label Text="No conversations yet."
                               HorizontalTextAlignment="Center"
                               FontSize="Medium"
                               TextColor="{StaticResource SecondaryTextColor}"/>
                    </StackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Grid>

        <!-- ===================================== -->
        <!-- ===== MAIN CHAT AREA (RIGHT) ====== -->
        <!-- ===================================== -->
        <Grid Grid.Column="1" RowDefinitions="Auto, *, Auto" Padding="10">

            <Grid Grid.Row="0" ColumnDefinitions="Auto, *, Auto" Padding="5" Margin="0,0,0,5">
                <Button x:Name="ToggleSidebarButton" Text="☰" FontAttributes="Bold" WidthRequest="50" Clicked="ToggleSidebarButton_Clicked" />

                <Label Grid.Column="1" x:Name="StatusLabel" Text="Please initialize the model." TextColor="{StaticResource SecondaryTextColor}" HorizontalTextAlignment="Center" VerticalTextAlignment="Center"/>

                <Button Grid.Column="2" x:Name="InitializeButton" Text="Initialize Model" Clicked="InitializeButton_Clicked" HorizontalOptions="End"/>
            </Grid>

            <Border Grid.Row="1" StrokeThickness="0" BackgroundColor="{StaticResource SidebarBackgroundColor}" Padding="10">
                <Editor x:Name="ConversationEditor"
                        IsReadOnly="True"
                        FontSize="Body"
                        TextColor="{StaticResource PrimaryTextColor}"
                        BackgroundColor="Transparent"
                        VerticalOptions="FillAndExpand"/>
            </Border>

            <Grid Grid.Row="2" ColumnDefinitions="*, Auto" ColumnSpacing="10" Margin="0,10,0,0" IsEnabled="False" x:Name="InputGrid">
                <Editor Grid.Column="0"
                        x:Name="PromptEditor"
                        Placeholder="Enter your prompt here..."
                        AutoSize="TextChanges"
                        TextColor="{StaticResource PrimaryTextColor}"
                        PlaceholderColor="{StaticResource SecondaryTextColor}"/>
                <Button Grid.Column="1"
                        x:Name="SendButton"
                        Text="➤"
                        FontSize="Large"
                        FontAttributes="Bold"
                        WidthRequest="60"
                        HeightRequest="60"
                        CornerRadius="30"
                        BackgroundColor="{StaticResource PrimaryAccentColor}"
                        TextColor="{StaticResource ButtonTextColor}"
                        Clicked="SendButton_Clicked">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding Source={x:Reference PromptEditor}, Path=Text.Length}" Value="0">
                            <Setter Property="IsEnabled" Value="False" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
            </Grid>

            <ActivityIndicator Grid.Row="1" x:Name="BusyIndicator" IsRunning="False" HorizontalOptions="Center" VerticalOptions="Center" Color="{StaticResource PrimaryAccentColor}" />
        </Grid>
    </Grid>
</ContentPage>